BootStrap: debootstrap
OSVersion: focal
MirrorURL: http://us.archive.ubuntu.com/ubuntu/

%files
    ORPER-companion.py /opt/ 

%environment
    export PATH=/usr/local/bin:$PATH
    export PATH=/opt/usr/local/bin:$PATH
    export PATH=/opt/BMGE-1.12:$PATH
    export PATH=/opt/hmmer/bin:$PATH
    export PATH=/opt/Prodigal:$PATH
    export PATH=/opt/pplacer-Linux-v1.1.alpha17:$PATH
    export PATH=/opt/mafft-7.471-with-extensions/core:$PATH
    export PATH=/opt/muscle:$PATH
    export PATH=/opt/scafos:$PATH 
    export SCAFOS=/opt/scafos
    export PATH=/opt/ncbi-blast-2.10.0+/bin:$PATH
    export PATH=/opt/bedtools2/bin:$PATH
    export PATH=/opt/barrnap/bin:$PATH
    export PATH=/opt/cdhit:$PATH
    export PATH=/opt/standard-RAxML:$PATH
    export PATH=/usr/local/bin:$PATH
    export LD_LIBRARY_PATH=/usr/local/lib64:$LD_LIBRARY_PATH
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib
    export CFLAGS="-I/usr/local/include"
    export LDFLAGS="-L/usr/local/lib"
    export PATH=/opt/Mash:$PATH
    export PATH=/opt/ANIcalculator_v1:$PATH
    export PATH=/opt/ORPER:$PATH 
    export PATH=/opt/R/4.0.5/bin:$PATH
    export PATH=/opt/FastANI:$PATH
    export PATH=${HOME}/edirect:${PATH}

%post
    # Ubuntu
    ## permission
    chmod -R 777 /opt         # chmod775 can be enough
    chmod -R 777 /root        # chmod775 can be enough
    ## update repository for apt
    apt update -y
    apt install -y software-properties-common
    apt-add-repository universe -y

    # Basic
    apt-get install -y wget
    apt-get install -y perl
    apt-get install -y build-essential
    apt-get install -y locales
    localedef -i en_US -f UTF-8 en_US.UTF-8
    apt-get install -y git
    apt-get install -y python3
    apt-get install -y wget
    apt-get install -y zip unzip
    apt-get install -y openjdk-11-jdk
    apt-get install -y capnproto
    apt-get install -y python3-pip
    pip3 install click
    ln -s /usr/bin/python3 /usr/bin/python
    ## Dependencies for pysam
    apt-get install -y libcurl4-openssl-dev
    apt-get install -y gcc
    apt-get install -y make
    apt-get install -y libbz2-dev
    apt-get install -y zlib1g-dev
    apt-get install -y libncurses5-dev 
    apt-get install -y libncursesw5-dev
    apt-get install -y liblzma-dev
    ### HTSLIB
    cd /opt/
    wget https://github.com/samtools/htslib/releases/download/1.9/htslib-1.9.tar.bz2
    tar -vxjf htslib-1.9.tar.bz2
    cd htslib-1.9
    make
    ## Dependencies for MASH
    apt-get install -y automake autoconf

    #NCBI Entrez
    cd /opt/
    sh -c "$(wget -q https://ftp.ncbi.nlm.nih.gov/entrez/entrezdirect/install-edirect.sh -O -)"

    # cpanm
    apt install cpanminus -y
    apt-get install liblwp-protocol-https-perl -y
    cpanm --force LWP::Protocol::https
    cpanm --force aliased
    cpanm Tk
    cpanm LWP::Simple
    cpanm Modern::Perl
    cpanm --force Bio::MUST::Core
    cpanm Bio::MUST::Drivers
    cpanm Bio::MUST::Apps::FortyTwo
    cpanm Data::UUID
    cpanm Data::GUID

    # BMGE
    cd /opt/
    wget ftp://ftp.pasteur.fr:21/pub/gensoft/projects/BMGE/BMGE-1.12.tar.gz
    tar -xzf BMGE-1.12.tar.gz
    cd BMGE-1.12
    echo '#!/bin/sh' >> bmge.sh
    echo 'java -jar /opt/BMGE-1.12/BMGE.jar -i $1 -t $2 -h $3 -g $4 -oh $5' >> bmge.sh
    chmod a+x bmge.sh
    export PATH=/opt/BMGE-1.12:$PATH

    # bzip2
    wget https://sourceforge.net/projects/bzip2/files/latest/download
    mv download bzip2-1.0.6.tar.gz
    tar -xzf bzip2-1.0.6.tar.gz
    cd bzip2-1.0.6
    make
    make install

    # HMMER 3
    apt-get install -y hmmer

    # Prodigal
    cd /opt
    git clone https://github.com/hyattpd/Prodigal
    cd Prodigal/
    make install

    # PPlacer
    cd /opt
    wget https://github.com/matsen/pplacer/releases/download/v1.1.alpha17/pplacer-Linux-v1.1.alpha17.zip
    unzip pplacer-Linux-v1.1.alpha17.zip

    # Checkm
    cd /opt
    pip3 install numpy
    pip3 install Pillow
    pip3 install matplotlib
    pip3 install Cython
    pip3 install pysam
    pip3 install checkm-genome
    mkdir checkm-data
    cd checkm-data/
    wget https://data.ace.uq.edu.au/public/CheckM_databases/checkm_data_2015_01_16.tar.gz
    tar -xzf checkm_data_2015_01_16.tar.gz
    checkm data setRoot /opt/checkm-data/

    # Mafft
    cd /opt/
    wget https://mafft.cbrc.jp/alignment/software/mafft-7.471-with-extensions-src.tgz
    gunzip -cd mafft-7.471-with-extensions-src.tgz | tar xfv -
    cd mafft-7.471-with-extensions
    cd core/
    make clean
    make
    make install

    # MUSCLE
    cd /opt/
    mkdir muscle
    cd muscle/
    wget https://www.drive5.com/muscle/downloads3.8.31/muscle3.8.31_i86linux64.tar.gz
    tar -xzf muscle3.8.31_i86linux64.tar.gz

    # Scafos
    cd /opt/
    wget http://www.tree-puzzle.de/tree-puzzle-5.3.rc16.tar.gz
    tar -xzf tree-puzzle-5.3.rc16.tar.gz
    cd tree-puzzle-5.3.rc16
    sh ./configure --prefix=/usr/local
    make
    make install
    cd /opt/
    mkdir scafos
    cd scafos/
    wget https://megasun.bch.umontreal.ca/Software/scafos/version/scafos_src_linux.125.tgz
    tar -xzf scafos_src_linux.125.tgz
    export SCAFOS=/opt/scafos
  
    # Mummer
    cd /opt/
    wget https://github.com/mummer4/mummer/releases/download/v3.9.4alpha/mummer-3.9.4alpha.tar.gz
    tar -xzf mummer-3.9.4alpha.tar.gz
    cd mummer-3.9.4alpha
    ./configure --prefix=/usr/local
    make
    make install

    # Blast
    cd /opt/    
    wget https://ftp.ncbi.nlm.nih.gov/blast/executables/blast+/2.10.0/ncbi-blast-2.10.0+-x64-linux.tar.gz
    tar -zxvf ncbi-blast-2.10.0+-x64-linux.tar.gz

    # bedtools
    cd /opt/
    wget https://github.com/arq5x/bedtools2/releases/download/v2.29.1/bedtools-2.29.1.tar.gz
    tar -zxvf bedtools-2.29.1.tar.gz
    cd bedtools2
    make
    export PATH=/opt/bedtools2/bin:$PATH

    # barnap
    cd /opt/
    git clone https://github.com/tseemann/barrnap.git
    export PATH=/opt/barrnap/bin:$PATH

    # cd-hit
    cd /opt/
    git clone https://github.com/weizhongli/cdhit
    cd cdhit/
    make

    # RaxML
    cd /opt/
    git clone https://github.com/stamatak/standard-RAxML
    cd standard-RAxML/
    make -f Makefile.PTHREADS.gcc
    make -f Makefile.AVX.PTHREADS.gcc
    rm -f *.o

    # capnp
    cd /opt/
    wget https://capnproto.org/capnproto-c++-0.8.0.tar.gz
    tar zxf capnproto-c++-0.8.0.tar.gz
    cd capnproto-c++-0.8.0
    ./configure
    make -j6 check
    make install

    # GSL
    cd /opt/
    wget ftp://ftp.gnu.org/gnu/gsl/gsl-2.6.tar.gz
    tar -zxvf gsl-2.6.tar.gz
    cd gsl-2.6
    ./configure
    make
    make check
    make install

    # Mash
    cd /opt/
    git clone https://github.com/marbl/Mash
    cd Mash/
    ./bootstrap.sh
    ./configure
    make
    make install

    # gANI
    cd /opt/
    wget https://ani.jgi.doe.gov/download_files/ANIcalculator_v1.tgz
    tar -xzf ANIcalculator_v1.tgz

    # Dependencies for dRep
    apt-get install -y libgsl-dev
    cd /opt/
    git clone https://github.com/ParBLiSS/FastANI
    cd FastANI/
    ./bootstrap.sh
    ./configure --prefix=/opt/usr/local/
    make
    
    # dRep
    pip3 install drep

    # R
    apt install -y dirmngr gnupg apt-transport-https ca-certificates software-properties-common
    apt-get install -y add-apt-key
    add-apt-key -k hkp://keyserver.ubuntu.com:80 E298A3A825C0D65DFD57CBB651716619E084DAB9
    add-apt-repository 'deb https://cloud.r-project.org/bin/linux/ubuntu focal-cran40/'
    apt install -y r-base


    # treeshrink
    cd /opt/
    git clone https://github.com/uym2/TreeShrink.git
    cd TreeShrink/
    python setup.py install
    run_treeshrink.py

    # ORPER
    cd /opt/
    mkdir ORPER
    mv ORPER-companion.py ORPER/

%runscript
    echo "This container contains : "
    Bio::MUST::Core 2020070 https://metacpan.org/pod/Bio::MUST::Core  
    Checkm 1.1.3 https://github.com/Ecogenomics/CheckM/wiki/Installation  
    dRep 3.2.2 https://drep.readthedocs.io/en/latest/  
    SCaFoS 1.25 https://megasun.bch.umontreal.ca/Software/scafos/scafos_install.html  
    CD-HIT 4.8.1 http://bioinformatics.org/cd-hit/  
    raxmlHPC-PTHREADS 8.2.12 https://cme.h-its.org/exelixis/web/software/raxml/cluster.html 
    Prodigal 2.6.3 https://github.com/hyattpd/Prodigal
    treeshrink 2.3.9 https://github.com/uym2/TreeShrink

%help
    This is a container for Nextflow-ORganismPlacER (ORPER) 
 
%labels
    Author Luc Cornet
    Version v1.0.0
